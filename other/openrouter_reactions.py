import re
from typing import Optional

LABEL_TO_EMOJI = {
    "backseat": "ðŸ¤¬",
    "Ð»ÑƒÑ‡ÑˆÐµÐµÐ±": "ðŸ¤”",
    "Ñ‡ÑÐ²ÑˆÐ½Ð¸Ðº": "ðŸ§",
    "ÐºÑ€Ð°ÑÐ°Ð²Ñ‡Ð¸Ðº": "ðŸ’ª",
    "Ð¾Ð±ÐµÑ‰Ð°Ð»ÐºÐ¸Ð½": "ðŸ¤",
    "Ð»Ð¸Ð´ÐµÑ€": "ðŸ«¡",
}

ALLOWED_LABELS = set(LABEL_TO_EMOJI.keys()) | {"none"}

SYSTEM_PROMPT = """
Ð¢Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑˆÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑˆÑŒ Ð ÐžÐ’ÐÐž ÐžÐ”Ð˜Ð Ñ‚Ð¾ÐºÐµÐ½ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ° Ð½Ð¸Ð¶Ðµ.
ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼, Ð±ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹, ÐºÐ°Ð²Ñ‹Ñ‡ÐµÐº Ð¸ Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸Ð¸.

Ð¢Ð¾ÐºÐµÐ½Ñ‹:
- backseat: Ð¸Ð¼Ð¿ÐµÑ€Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ð¼Ñƒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÑƒ (Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ).
- Ð»ÑƒÑ‡ÑˆÐµÐµÐ±: Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ "Ð½Ð°Ð´Ð¾/Ð½ÑƒÐ¶Ð½Ð¾/ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð»Ð¾ Ð±Ñ‹/Ð±Ñ‹Ð»Ð¾ Ð±Ñ‹ Ð½ÐµÐ¿Ð»Ð¾Ñ…Ð¾/ÐºÐ¾Ð¼Ñƒ-Ñ‚Ð¾ ÑÑ‚Ð¾Ð¸Ñ‚" Ð¿Ñ€Ð¾ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ ÐºÑ‚Ð¾-Ñ‚Ð¾ (Ð½Ðµ Ð°Ð²Ñ‚Ð¾Ñ€) Ð´Ð¾Ð»Ð¶ÐµÐ½ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ.
- Ñ‡ÑÐ²ÑˆÐ½Ð¸Ðº: Ñ-Ð²Ñ‹ÑÐºÐ°Ð·Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¼Ð½ÐµÐ½Ð¸Ñ ("Ñ Ð´ÑƒÐ¼Ð°ÑŽ/ÑÑ‡Ð¸Ñ‚Ð°ÑŽ/Ð¿Ð¾-Ð¼Ð¾ÐµÐ¼Ñƒ/Ð½Ð° Ð¼Ð¾Ð¹ Ð²Ð·Ð³Ð»ÑÐ´").
- ÐºÑ€Ð°ÑÐ°Ð²Ñ‡Ð¸Ðº: Ñ-Ð²Ñ‹ÑÐºÐ°Ð·Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¾ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð±ÐµÐ· ÑÐ»Ð¾Ð² "Ñ…Ð¾Ñ‡Ñƒ/Ð¼Ð¾Ð³Ñƒ/Ð³Ð¾Ñ‚Ð¾Ð²/Ð±ÐµÑ€ÑƒÑÑŒ/Ð·Ð°Ð¹Ð¼ÑƒÑÑŒ".
- Ð¾Ð±ÐµÑ‰Ð°Ð»ÐºÐ¸Ð½: Ñ-Ð²Ñ‹ÑÐºÐ°Ð·Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ñ "Ñ…Ð¾Ñ‡Ñƒ/Ð¼Ð¾Ð³Ñƒ/Ð³Ð¾Ñ‚Ð¾Ð²/Ð±ÐµÑ€ÑƒÑÑŒ/Ð·Ð°Ð¹Ð¼ÑƒÑÑŒ".
- Ð»Ð¸Ð´ÐµÑ€: ÐºÐ°Ðº "ÐºÑ€Ð°ÑÐ°Ð²Ñ‡Ð¸Ðº", Ð½Ð¾ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ ÑÑ€Ð¾ÐºÐ°/Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ð°.

Ð•ÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð½Ð¸ Ð¾Ð´Ð½Ð° ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ, Ð²ÐµÑ€Ð½Ð¸: none.
Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾, Ð²Ñ‹Ð±Ð¸Ñ€Ð°Ð¹ Ð¿Ð¾ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ñƒ: Ð»Ð¸Ð´ÐµÑ€, Ð¾Ð±ÐµÑ‰Ð°Ð»ÐºÐ¸Ð½, ÐºÑ€Ð°ÑÐ°Ð²Ñ‡Ð¸Ðº, backseat, Ð»ÑƒÑ‡ÑˆÐµÐµÐ±, Ñ‡ÑÐ²ÑˆÐ½Ð¸Ðº.
""".strip()


def build_messages(text: str) -> list[dict[str, str]]:
    return [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "user", "content": text},
    ]


def normalize_label(value: Optional[str]) -> Optional[str]:
    if not value:
        return None
    token = re.split(r"\s+", value.strip().lower())[0]
    token = token.strip("`\"'.,:;!()[]{}<>")
    if token in ALLOWED_LABELS:
        return None if token == "none" else token
    return None


def label_to_emoji(label: Optional[str]) -> Optional[str]:
    if not label:
        return None
    return LABEL_TO_EMOJI.get(label)
